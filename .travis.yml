language: c

sudo: required

dist: trusty

env:
  global:
    - PREFIX="$HOME/build"
    - PATH="$PREFIX/bin:$PATH"
    - CFLAGS="-L$PREFIX/lib"
    - CPPFLAGS="-I$PREFIX/include"
    - PKG_CONFIG_PATH="$PREFIX/lib/pkgconfig"
    - ARCH="amd64"
  matrix:
    - MYCC="gcc-4.9"
    - MYCC="gcc-5"
    - MYCC="gcc-6"
    - MYCC="gcc-7"
    - MYCC="gcc-7
      ARCH="i386"
      CFLAGS="-m32 -L$PREFIX/lib"

cache: false

branches:
  only:
    - master
    - travis

before_install:
  - "CC=$MYCC"
  - 'PKG_CONFIG_PATH="$PKG_CONFIG_PATH:/usr/lib/$ARCH-linux-gnu/pkgconfig"'
  - travis_retry sudo apt-add-repository -y ppa:ubuntu-toolchain-r/test
  - travis_retry sudo apt-add-repository -y ppa:jbboehr/build-deps
  - travis_retry sudo apt-add-repository -y ppa:jbboehr/handlebars
  - travis_retry sudo apt-get update -y
  - travis_retry sudo apt-get install -y $CC
  - travis_retry sudo apt-get install -y automake bison flex gperf lcov pkg-config re2c gcc-multilib
  - travis_retry sudo apt-get install -y check:$ARCH libjson-c-dev:$ARCH liblmdb-dev:$ARCH libpcre3-dev:$ARCH libtalloc-dev:$ARCH libyaml-dev:$ARCH libsubunit-dev:$ARCH
  - travis_retry gem install coveralls-lcov

install:
  - ./bootstrap
  - ./configure --build="$ARCH" --prefix="$PREFIX" --enable-handlebars-memory CFLAGS="-g -O3 --coverage -fprofile-arcs -ftest-coverage $CFLAGS" LDFLAGS="--coverage"
  - make clean all

before_script:
  - lcov --directory . --zerocounters
  - lcov --directory . --capture --compat-libtool --initial --output-file coverage.info

script:
  - make check install

after_success:
  - lcov --no-checksum --directory . --capture --compat-libtool --output-file coverage.info
  - lcov --remove coverage.info "/usr*" --remove coverage.info "*/tests/*" --remove coverage.info "handlebars.tab.c" --remove coverage.info "handlebars.lex.c" --remove coverage.info "handlebars_scanners.c" --compat-libtool --output-file coverage.info
  - coveralls-lcov coverage.info

after_failure:
  - for i in `find tests -name "*.log" 2>/dev/null`; do echo "-- START ${i}"; cat $i; echo "-- END"; done

